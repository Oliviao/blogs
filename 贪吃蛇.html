<!doctype html>
<html>
    <head>
        <style>
            .map{
                position: relative;
                width: 400px;
                height: 400px;
                margin: 20px;
                background: -webkit-linear-gradient(top, transparent 19px, rgb(71, 66, 68) 20px),-webkit-linear-gradient(left, transparent 19px, rgb(71, 66, 68) 20px);
                background-size: 20px 20px;
                background-color: black;
            }
            .snake > div {
                width: 20px;
                height: 20px;
                background-color: red;
            }
            button{
                width: 80px;
                height: 60px;
                cursor: pointer;
                font-size: 20px;
            }
            button:hover {
                background-color: blanchedalmond;
            }
        </style>
    </head>
    <body>
        <div class="wrap">
            <button class="reset button">重置</button>
            <button class="start button">开始</button>
        </div>
        <script>
            // 遗留问题：点击“重置”有用，检测碰撞到自己了，整体逻辑整理一下
            var UNIT = 20
            // 400*400
            var RESET_BUTTON = document.querySelector('.reset')
            var START_BUTTON = document.querySelector('.start')
            var WRAP = document.querySelector('.wrap')

            class Map{
                constructor(){
                    this.width = 20
                    this.height = 20
                    this._unit = 20
                    this._map = null
                }
                create() {
                    var div = document.createElement('div')
                    div.classList.add('map')

                    this._map = div
                    WRAP.insertBefore(div, WRAP.firstChild)
                }
            }
            var map = new Map()
            map.create()

            // 食物
            class Food{
                constructor(){
                    this.x = Math.floor(Math.random()*20)
                    this.y = Math.floor(Math.random()*20)
                    this.color = '#ff' + String(Math.random()).slice(2,6)

                    var div = document.createElement('div')
                    div.style.backgroundColor = this.color
                    div.style.position = 'absolute'
                    div.style.left = this.x * 20 + 'px'
                    div.style.top = this.y * 20 + 'px'
                    div.style.width = '20px'
                    div.style.height = '20px'
                    div.style.borderRadius = '10px'

                    this._food = div
                    map._map.appendChild(div)
                }
                remove() {
                    this._food.remove()
                }
            }
            var food = new Food()
            console.log(food)

            class Block{
                constructor(x, y, color){
                    this.x = x
                    this.y = y
                    this.color = color || "green"
                }
            }

            // 蛇
            class Snake{
                constructor(){
                    this.width = 1
                    this.height = 1
                    this.direction = 'right'
                    this._snake = [].concat(new Block(4, 8, 'green'), new Block(3, 8, 'green'))
                }
                createSnake(){
                    this.remove()

                    var length = this._snake.length
                    for(var i = 0; i < length; i++) {
                        var block = this._snake[i]

                        var div = document.createElement('div')
                        div.classList.add('snake')
                        div.style.position = 'absolute'
                        div.style.top = block.y * 20 + 'px'
                        div.style.left = block.x * 20 + 'px'
                        div.style.backgroundColor = block.color
                        div.style.width = '20px'
                        div.style.height = '20px'

                        map._map.appendChild(div)
                    }
                }
                move(){
                    var direction = this.direction
                    // 蛇尾走到蛇头前边
                    var _snakeTail = this._snake.pop()
                    this._snake.unshift({..._snakeTail})
                    var _snakeHead = this._snake[0]
                    var _snakeSecond = this._snake[1]

                    switch(direction) {
                        case 'right':
                            _snakeHead.x = (_snakeSecond.x + 1 > 19) ? 0 : _snakeSecond.x + 1
                            _snakeHead.y = _snakeSecond.y
                            break
                        case 'left':
                            _snakeHead.x = (_snakeSecond.x - 1 < 0) ? 19 : _snakeSecond.x - 1
                            _snakeHead.y = _snakeSecond.y
                            break
                        case 'up':
                            _snakeHead.y = (_snakeSecond.y - 1 < 0) ? 19 : _snakeSecond.y - 1
                            _snakeHead.x = _snakeSecond.x
                            break
                        case 'down':
                            _snakeHead.y = (_snakeSecond.y + 1 > 19) ? 0 : _snakeSecond.y + 1
                            _snakeHead.x = _snakeSecond.x
                    }

                    // 碰撞检测：吃到食物
                    if(_snakeHead.x == food.x && _snakeHead.y == food.y) {
                        console.log(true)
                        _snakeTail.color = food.color
                        this._snake.push(_snakeTail)
                        food.remove()

                        food = new Food()
                    }
                    
                    this.createSnake()
                    setTimeout(() => {
                        this.move()
                    }, 500)
                }
                remove(){
                    var snake = document.getElementsByClassName('snake')
                    for(var i = snake.length - 1; i >= 0; i--) {
                        map._map.removeChild(snake[i]);
                    }
                }
            }
            
            var snake = new Snake()
            
            function init(){
                snake.createSnake()
            }

            // 初始化面板
            init()

            RESET_BUTTON.addEventListener('click', function(){
                init()
            })

            START_BUTTON.addEventListener('click', function(){
                snake.move()
            })

            document.addEventListener('keydown', function(event){
                var code = event.code
                switch(code) {
                    case 'ArrowUp':
                        if(snake.dir != 'down') {
                            snake.direction = 'up'
                        }
                        break
                    case 'ArrowDown':
                        if(snake.direction != 'up') {
                            snake.direction = 'down'
                        }
                        break
                    case 'ArrowLeft':
                        if(snake.direction != 'right') {
                            snake.direction = 'left'
                        }  
                        break 
                    case 'ArrowRight':
                        if(snake.direction !== 'left') {
                            snake.direction = 'right'
                        }  
                        break 
                }
            })
        </script>
    </body>
</html>